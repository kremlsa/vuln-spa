stages:
  - review

variables:
  OPENAI_API_KEY: "$OPENAI_API_KEY"
  OPENAI_API_BASE_URL: "https://api.openai.com/v1"
  OPENAI_MODEL: "gpt-4o"
  OPENAI_SYSTEM_ROLE: "Ð¢Ñ‹ Ð¿Ð¾Ð¼Ð¾Ñ‰Ð½Ð¸Ðº Ð¿Ð¾ code review. ÐŸÑ€Ð¾Ð°Ð½Ð°Ð»Ð¸Ð·Ð¸Ñ€ÑƒÐ¹ diff Ð¸ Ð¿Ñ€ÐµÐ´Ð»Ð¾Ð¶Ð¸ ÑƒÐ»ÑƒÑ‡ÑˆÐµÐ½Ð¸Ñ."
  MCP_PATH: "mcp/mcp.json"

ai_review:
  stage: review
  image: docker.io/kremlsa/review-bot:latest
  script:
    - echo "ðŸ“¦ Ð“ÐµÐ½ÐµÑ€Ð¸Ñ€ÑƒÐµÐ¼ diff..."
    - git fetch origin "$CI_MERGE_REQUEST_TARGET_BRANCH_NAME"
    - git diff origin/"$CI_MERGE_REQUEST_TARGET_BRANCH_NAME"...HEAD > mcp/diff.patch

    - echo "ðŸ“ Ð“ÐµÐ½ÐµÑ€Ð¸Ñ€ÑƒÐµÐ¼ mcp.json"
    - mkdir -p mcp
    - |
      cat > mcp/mcp.json <<EOF
      {
        "diff": "mcp/diff.patch"
      }
      EOF

    - echo "ðŸ¤– Ð—Ð°Ð¿ÑƒÑÐº AI Ð±Ð¾Ñ‚Ð°"
    - /app/ai_review_bot
  only:
    - merge_requests
  artifacts:
    paths:
      - mcp/ai_reply.md
    when: always
